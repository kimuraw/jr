#!/usr/bin/env ruby
# coding: utf-8

require 'jr/cli/version'
require 'optparse'
require 'yajl'

opt = OptionParser.new
opt.banner  = "jr - Command-line JSON processor for Rubyists [Ver. #{Jr::Cli::VERSION}]\n\n" +
              "Usage: jr [options] <jr filter> [file...]"
opt.version = Jr::Cli::VERSION
opt.on('-r FILE', 'require the FILE before execution') {|file| require file }
opt.parse! ARGV

require 'jr/cli/core_ext'

trap('INT') { exit 130 }

inputs = ARGV[1] ? ARGV[1..-1].map {|f| open f } : [STDIN]
result = Enumerator.new do |yielder|
  inputs.each do |input|
    Yajl::Parser.new(symbolize_keys: true).parse(input) do |d|
      yielder.yield d
    end
  end
end.lazy.instance_eval(ARGV[0])

encoder = Yajl::Encoder.new(pretty: true)

if result.is_a? Array or result.kind_of? Enumerator
  result.each do |data|
    puts encoder.encode(data)
  end
else
  puts encoder.encode(result)
end
